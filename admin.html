<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>√Årea ADM ‚Ä¢ RR Consultoria</title>

  <link rel="stylesheet" href="./app.css?v=400">
  <script src="./config.js?v=400"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="page">
    <div class="card">

      <header class="topbar">
        <div class="brand">
          <img class="brand-logo" id="logoImg" src="./Logo.png" alt="Logo" onerror="this.style.display='none'">
          <div class="brand-text">
            <div class="brand-title" id="companyName">RR Consultoria</div>
            <div class="brand-sub">√Årea ADM</div>
            <div class="brand-sub mini" id="loggedAs" style="opacity:.9"></div>
          </div>
        </div>

        <div class="top-actions">
          <button class="btn btn-secondary" id="btnSupport" type="button">Suporte</button>
          <button class="btn btn-danger" id="btnLogout" type="button">Sair</button>
        </div>
      </header>

      <main class="content">
        <section class="block">
          <div class="pill">Painel</div>
          <div id="status" class="mini" style="margin-top:10px; line-height:1.5">Carregando‚Ä¶</div>
          <div id="msg" class="msg" aria-live="polite" style="margin-top:12px; opacity:0"></div>

          <div style="margin-top:14px; display:grid; gap:10px;">
            <a class="btn btn-primary" href="./admin-clients.html?v=400" style="text-decoration:none; text-align:center;">
              Gerenciar clientes
            </a>

            <a class="btn btn-secondary" href="./admin-payments.html?v=400" style="text-decoration:none; text-align:center;">
              Pagamentos
            </a>

            <a class="btn btn-secondary" href="./admin-plans.html?v=400" style="text-decoration:none; text-align:center;">
              Gerenciar planos
            </a>

            <a class="btn btn-secondary" href="./index.html?v=400" style="text-decoration:none; text-align:center;">
              Voltar pro portal
            </a>
          </div>
        </section>
      </main>

      <footer class="footer">
        <span id="footerCompany">¬© RR Consultoria</span>
      </footer>

    </div>
  </div>

<script>
  const CFG = window.APP_CONFIG || {};
  const sb = (window.supabase?.createClient ? window.supabase : supabase)
    .createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  const setText = (id, v) => { const el = $(id); if (el) el.textContent = v ?? ''; };

  $('logoImg').src = CFG.LOGO_URL || './Logo.png';
  if (CFG.COMPANY_NAME) setText('companyName', CFG.COMPANY_NAME);
  setText('footerCompany', `¬© ${CFG.COMPANY_NAME || 'RR Consultoria'}`);

  const msgEl = $('msg');
  const setMsg = (t, ok=false) => {
    msgEl.textContent = t || '';
    msgEl.style.opacity = t ? '1' : '0';
    msgEl.style.color = ok ? 'rgba(86,255,180,.95)' : 'rgba(255,255,255,.82)';
  };

  function openSupport(){
    const phone = (CFG.SUPPORT_WHATSAPP || '').replace(/\D/g,'');
    const text  = encodeURIComponent(CFG.SUPPORT_MESSAGE || 'Ol√°! Preciso de ajuda com o Portal.');
    if (!phone) return alert('WhatsApp de suporte n√£o configurado.');
    window.location.href = `https://wa.me/${phone}?text=${text}`;
  }
  $('btnSupport').addEventListener('click', openSupport);

  async function doLogout(){
    await sb.auth.signOut();
    window.location.href = './login.html?v=400';
  }
  $('btnLogout').addEventListener('click', doLogout);

  async function requireAdmin(session){
    const uid = session.user.id;
    const { data, error } = await sb
      .from('admins')
      .select('user_id')
      .eq('user_id', uid)
      .maybeSingle();
    if (error) throw error;
    return !!data?.user_id;
  }

  async function boot(){
    setMsg('');

    const { data: sessData, error: sessErr } = await sb.auth.getSession();
    if (sessErr) {
      setText('status', 'Erro de sess√£o.');
      setMsg(sessErr.message);
      window.location.href = './login.html?v=400';
      return;
    }

    const session = sessData?.session;
    if (!session) {
      window.location.href = './login.html?v=400';
      return;
    }

    const email = session.user.email;
    setText('loggedAs', email ? `Logado como: ${email}` : '');

    try{
      const ok = await requireAdmin(session);
      if (!ok) {
        setText('status', 'Voc√™ n√£o tem permiss√£o de ADM.');
        setMsg('Acesso negado.');
        window.location.href = './index.html?v=400';
        return;
      }
    } catch(e){
      console.error(e);
      setText('status', 'Erro ao validar ADM.');
      setMsg(e.message || 'Erro.');
      return;
    }

    setText('status', 'Acesso ADM liberado ‚úÖ');
    setMsg('Tudo certo. Escolha um atalho abaixo üëá', true);
  }

  boot();
</script>

</body>
</html>
