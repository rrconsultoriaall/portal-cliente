<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Portal do Cliente</title>

  <link rel="stylesheet" href="./app.css?v=99" />
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="./config.js?v=99"></script>
</head>

<body>
  <div class="shell">
    <div class="card">

      <div class="topbar">
        <div class="brand">
          <img id="logoImg" src="./Logo.png" alt="Logo" />
          <div class="title">
            <strong id="companyName">Portal do Cliente</strong>
            <span id="companyTagline">Carregando sessão...</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn ghost" id="btnSupport" type="button">Suporte</button>
          <button class="btn danger" id="btnLogout" type="button">Sair</button>
        </div>
      </div>

      <div class="content">
        <div class="panel">
          <div class="badge"><span class="dot"></span> Seus contratos</div>
          <div id="contractsBox" class="contracts">
            <p class="muted" id="loadingText">Carregando...</p>
          </div>
        </div>

        <div class="panel" style="margin-top:16px">
          <h2 class="h2">Resumo</h2>
          <div class="summary">
            <div class="row"><span class="k">Status</span><span class="v" id="sumStatus">—</span></div>
            <div class="row"><span class="k">Próximo vencimento</span><span class="v" id="sumDue">—</span></div>
            <div class="row"><span class="k">Parcelas restantes</span><span class="v" id="sumInst">—</span></div>
          </div>

          <div id="msg" class="msg" style="display:none;margin-top:12px"></div>
        </div>
      </div>

      <div class="footer">
        <small>© <span id="footerCompany">Sua empresa</span></small>
      </div>

    </div>
  </div>

  <script>
    window.addEventListener("load", async () => {
      const msg = document.getElementById("msg");
      const showMsg = (text, type="error") => {
        msg.style.display = "block";
        msg.className = "msg " + type;
        msg.textContent = text;
      };

      const cfg = window.APP_CONFIG;
      if (!cfg || !cfg.SUPABASE_URL || !cfg.SUPABASE_ANON_KEY) {
        showMsg("❌ Config não carregou (config.js).", "error");
        return;
      }

      document.getElementById("companyName").textContent = cfg.COMPANY_NAME || "Portal do Cliente";
      document.getElementById("companyTagline").textContent = cfg.COMPANY_TAGLINE || "Acesse seus contratos";
      document.getElementById("footerCompany").textContent = cfg.COMPANY_NAME || "Sua empresa";
      document.getElementById("logoImg").src = (cfg.LOGO_URL || "./Logo.png") + "?v=99";

      const supabase = window.supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);

      // ✅ Botões (amarrados no load — não falha)
      document.getElementById("btnSupport").addEventListener("click", (e) => {
        e.preventDefault();
        const phone = (cfg.SUPPORT_WHATSAPP || "").replace(/\D/g, "");
        const text = encodeURIComponent(cfg.SUPPORT_MESSAGE || "Olá! Preciso de ajuda com o portal.");
        if (!phone) return showMsg("WhatsApp não configurado.", "error");
        window.open(`https://wa.me/${phone}?text=${text}`, "_blank");
      });

      document.getElementById("btnLogout").addEventListener("click", async (e) => {
        e.preventDefault();
        try { await supabase.auth.signOut(); } catch (_) {}
        try { localStorage.clear(); sessionStorage.clear(); } catch (_) {}
        window.location.replace("./login.html?v=99");
      });

      // ✅ Sessão
      const { data: sessData, error: sessErr } = await supabase.auth.getSession();
      if (sessErr) {
        showMsg("❌ Erro ao ler sessão: " + sessErr.message, "error");
        window.location.replace("./login.html?v=99");
        return;
      }
      if (!sessData?.session) {
        showMsg("⚠️ Sem sessão. Voltando pro login...", "warn");
        window.location.replace("./login.html?v=99");
        return;
      }

      const session = sessData.session;
      const userId = session.user.id;
      const email = session.user.email || "";
      document.getElementById("companyTagline").textContent = "Logado como: " + email;

      // 1) clients pelo user_id
      const { data: client, error: clientErr } = await supabase
        .from("clients")
        .select("id, full_name")
        .eq("user_id", userId)
        .maybeSingle();

      if (clientErr) {
        showMsg("❌ Erro clients: " + clientErr.message, "error");
        document.getElementById("loadingText").textContent = "Erro ao buscar cliente.";
        return;
      }
      if (!client?.id) {
        showMsg("⚠️ Nenhum cliente vinculado a este usuário (clients.user_id).", "warn");
        document.getElementById("loadingText").textContent = "Nenhum cliente encontrado.";
        return;
      }

      // 2) contracts pelo client_id
      const { data: contracts, error: ctrErr } = await supabase
        .from("contracts")
        .select("id, amount_paid, installments_remaining, due_date, notes, created_at")
        .eq("client_id", client.id)
        .order("created_at", { ascending: false });

      if (ctrErr) {
        showMsg("❌ Erro contracts: " + ctrErr.message, "error");
        document.getElementById("loadingText").textContent = "Erro ao buscar contratos.";
        return;
      }

      const box = document.getElementById("contractsBox");
      box.innerHTML = "";

      if (!contracts || contracts.length === 0) {
        box.innerHTML = `<p class="muted">Nenhum contrato encontrado.</p>`;
        return;
      }

      for (const c of contracts) {
        const due = c.due_date ? new Date(c.due_date + "T00:00:00") : null;
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        let status = "Em dia";
        if (c.installments_remaining === 0) status = "Quitado";
        else if (due && due < today) status = "Atrasado";

        const amount = (c.amount_paid ?? 0).toLocaleString("pt-BR", { style:"currency", currency:"BRL" });

        const el = document.createElement("div");
        el.className = "contractItem";
        el.innerHTML = `
          <div class="contractTop">
            <div class="pill ${status === "Atrasado" ? "bad" : status === "Quitado" ? "ok" : "warn"}">${status}</div>
            <div class="muted small">#${c.id.slice(0,8)}</div>
          </div>

          <div class="contractGrid">
            <div><span class="k">Valor pago</span><span class="v">${amount}</span></div>
            <div><span class="k">Parcelas restantes</span><span class="v">${c.installments_remaining ?? "—"}</span></div>
            <div><span class="k">Vencimento</span><span class="v">${c.due_date ?? "—"}</span></div>
          </div>

          ${c.notes ? `<div class="notes"><span class="k">Observações</span><span class="v">${c.notes}</span></div>` : ""}
        `;
        box.appendChild(el);
      }

      const c0 = contracts[0];
      document.getElementById("sumDue").textContent = c0.due_date || "—";
      document.getElementById("sumInst").textContent = (c0.installments_remaining ?? "—");

      // status resumo
      const due0 = c0.due_date ? new Date(c0.due_date + "T00:00:00") : null;
      const today0 = new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
      let status0 = "Em dia";
      if (c0.installments_remaining === 0) status0 = "Quitado";
      else if (due0 && due0 < today0) status0 = "Atrasado";
      document.getElementById("sumStatus").textContent = status0;

      showMsg("✅ Portal carregado com sucesso.", "ok");
    });
  </script>
</body>
</html>
