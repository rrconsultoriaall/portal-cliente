<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Portal</title>
  <link rel="stylesheet" href="./style.css?v=99">
</head>
<body>

<div class="wrap">
  <div class="card">

    <header class="brand">
      <img id="logoImg" class="logo" src="./Logo.png" alt="Logo" />
      <div class="brand-text">
        <div id="companyName" class="brand-title">Admin</div>
        <div class="brand-sub">Gerenciar clientes e contratos</div>
        <div id="loggedAs" class="brand-sub mini" style="opacity:.9"></div>
      </div>

      <div class="top-actions">
        <button class="btn btn-secondary" id="btnPortal" type="button">Portal</button>
        <button class="btn btn-danger" id="btnLogout" type="button">Sair</button>
      </div>
    </header>

    <main class="content">

      <section class="block">
        <div class="pill">Admin</div>
        <div id="adminArea" class="mini">Carregando...</div>
        <div id="msg" class="msg" aria-live="polite"></div>
      </section>

    </main>

    <footer class="footer">
      <span id="footerCompany">© Sua empresa</span>
    </footer>

  </div>
</div>

<script src="./config.js?v=99"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const CFG = window.APP_CONFIG || {};
  const sb = (window.supabase?.createClient ? window.supabase : supabase)
    .createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY);

  const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v ?? ''; };
  const msg = document.getElementById('msg');
  const setMsg = (t, ok=false) => {
    msg.textContent = t || '';
    msg.style.opacity = t ? '1' : '0';
    msg.style.color = ok ? 'rgba(86,255,180,.95)' : 'rgba(255,255,255,.82)';
  };

  document.getElementById('logoImg').src = CFG.LOGO_URL || './Logo.png';
  if (CFG.COMPANY_NAME) setText('companyName', `${CFG.COMPANY_NAME} • Admin`);
  setText('footerCompany', `© ${CFG.COMPANY_NAME || 'Sua empresa'}`);

  document.getElementById('btnPortal').addEventListener('click', () => {
    window.location.href = './index.html?v=99';
  });

  document.getElementById('btnLogout').addEventListener('click', async () => {
    await sb.auth.signOut();
    window.location.href = './login.html?v=99';
  });

  async function requireAdmin(){
    const { data } = await sb.auth.getSession();
    if (!data?.session) { window.location.href = './login.html?v=99'; return null; }

    setText('loggedAs', `Logado como: ${data.session.user.email}`);

    const { data: adm, error } = await sb
      .from('admins')
      .select('user_id')
      .eq('user_id', data.session.user.id)
      .maybeSingle();

    if (error) { setMsg(error.message); return null; }
    if (!adm) {
      document.getElementById('adminArea').textContent = 'Acesso negado. Você não é admin.';
      return null;
    }

    return data.session;
  }

  (async () => {
    const session = await requireAdmin();
    if (!session) return;

    document.getElementById('adminArea').innerHTML = `
      <div class="mini" style="opacity:.9; line-height:1.5">
        ✅ Você está como admin.<br/>
        Agora você pode gerenciar dados diretamente no Supabase (tables) e o portal do cliente vai refletir isso.
      </div>
    `;
    setMsg('Admin carregado ✅', true);
  })();
</script>

</body>
</html>
