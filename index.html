<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Portal do Cliente</title>

  <link rel="stylesheet" href="app.css?v=1000"/>
  <script src="config.js?v=1000"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="page">
<div class="card">

  <!-- TOPO -->
  <div class="topbar">
    <div class="brand">
      <img class="brand-logo" id="logoImg" src="Logo.png" alt="Logo">
      <div class="brand-text">
        <div class="brand-title" id="companyName">RR Consultoria</div>
        <div class="brand-sub" id="companyTagline">Assessoria & Consultoria</div>
        <div class="brand-sub" id="loggedAs"></div>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn btn-secondary" id="btnSupport">Suporte</button>
      <button class="btn btn-danger" id="btnLogout">Sair</button>
    </div>
  </div>

  <!-- PORTAL -->
  <div class="block">
    <div class="pill">Portal</div>
    <div class="msg">Bem-vindo! ✅</div>
  </div>

  <!-- PLANO -->
  <div class="block">
    <div class="pill">Seu plano</div>
    <div id="planArea" class="mini">Carregando...</div>
  </div>

  <!-- AÇÕES -->
  <div class="block">
    <h2>Ações</h2>

    <a class="action-link" href="pagamentos.html">
      <div>
        <strong>Pagamentos</strong><br/>
        <span>Histórico e comprovantes</span>
      </div>
      <div class="chev">›</div>
    </a>

    <br/>

    <a class="action-link" href="perfil.html">
      <div>
        <strong>Perfil</strong><br/>
        <span>Seus dados cadastrais</span>
      </div>
      <div class="chev">›</div>
    </a>

    <br/>

    <a class="action-link" href="detalhes.html">
      <div>
        <strong>Detalhes</strong><br/>
        <span>Contrato e informações extras</span>
      </div>
      <div class="chev">›</div>
    </a>
  </div>

  <div class="footer">© RR Consultoria</div>

</div>
</div>

<script>
const CFG = window.APP_CONFIG || {};
const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY);

function fmt(v){
  return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
}

async function boot(){

  const { data: sess } = await sb.auth.getSession();
  if(!sess.session){
    window.location.href="login.html";
    return;
  }

  const user = sess.session.user;
  document.getElementById("loggedAs").textContent = "Logado como: " + user.email;

  const { data: client } = await sb
    .from("clients")
    .select("id,is_active")
    .eq("user_id", user.id)
    .single();

  if(!client || client.is_active !== true){
    document.getElementById("planArea").innerHTML = "Aguardando aprovação do administrador.";
    return;
  }

  const { data } = await sb
    .from("client_plan_progress")
    .select("*")
    .eq("email", user.email)
    .single();

  if(!data){
    document.getElementById("planArea").innerHTML = "Erro ao carregar plano.";
    return;
  }

  document.getElementById("planArea").innerHTML = `
    <strong>${data.plan_name}</strong><br/>
    <br/>
    <strong>Entrada</strong><br/>
    Pago ${fmt(data.entry_paid)} de ${fmt(data.entry_total)} (${data.entry_progress_percent.toFixed(2)}%)
    <div class="progress"><div class="bar" style="width:${data.entry_progress_percent}%"></div></div>
    <br/>
    <strong>Principal</strong><br/>
    Pago ${fmt(data.main_paid)} de ${fmt(data.main_total)} (${data.main_progress_percent.toFixed(2)}%)
    <div class="progress"><div class="bar" style="width:${data.main_progress_percent}%"></div></div>
    <br/>
    <strong>Geral</strong><br/>
    Pago ${fmt(data.paid_total)} de ${fmt(data.plan_total)} (${data.progress_percent.toFixed(2)}%)
    <div class="progress"><div class="bar" style="width:${data.progress_percent}%"></div></div>
  `;
}

document.getElementById("btnLogout").onclick = async ()=>{
  await sb.auth.signOut();
  window.location.href="login.html";
};

document.getElementById("btnSupport").onclick = ()=>{
  window.location.href="https://wa.me/55SEUNUMERO";
};

boot();
</script>

</body>
</html>
