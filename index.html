<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portal do Cliente</title>

<link rel="stylesheet" href="./app.css?v=201">
<script src="/portal-cliente/config.js?v=201"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="page">
<div class="card">

<div class="brand">
  <img class="brand-logo" src="/portal-cliente/Logo.png" />
  <div class="brand-text">
    <div class="brand-title">RR Consultoria</div>
    <div class="brand-sub">Assessoria & Consultoria</div>
    <div class="brand-sub mini" id="loggedAs"></div>
  </div>
</div>

<div class="block">
  <div class="pill">Portal</div>
  <div>Bem-vindo! ✅</div>
</div>

<div class="block">
  <div class="pill">Seu plano</div>
  <div id="planArea">Carregando...</div>
</div>

<div class="block">
  <h2>Ações</h2>

  <a class="action-link" href="/portal-cliente/pagamentos.html?v=201">
    <div>
      <strong>Pagamentos</strong><br>
      <span>Histórico e comprovantes</span>
    </div>
    <div class="chev">›</div>
  </a>

  <br>

  <a class="action-link" href="/portal-cliente/perfil.html?v=201">
    <div>
      <strong>Perfil</strong><br>
      <span>Seus dados cadastrais</span>
    </div>
    <div class="chev">›</div>
  </a>

  <br>

  <a class="action-link" href="/portal-cliente/detalhes.html?v=201">
    <div>
      <strong>Detalhes</strong><br>
      <span>Contrato e informações extras</span>
    </div>
    <div class="chev">›</div>
  </a>
</div>

<div class="footer">
© RR Consultoria
</div>

</div>
</div>

<script>
const sb = supabase.createClient(
  window.APP_CONFIG.SUPABASE_URL,
  window.APP_CONFIG.SUPABASE_ANON_KEY
);

async function boot(){
  const { data } = await sb.auth.getSession();
  const session = data.session;
  if(!session){
    window.location.href="/portal-cliente/login.html?v=201";
    return;
  }

  document.getElementById("loggedAs").textContent =
    "Logado como: " + session.user.email;

  const { data: plan } = await sb
    .from("client_plan_progress")
    .select("*")
    .eq("email", session.user.email)
    .maybeSingle();

  if(!plan){
    document.getElementById("planArea").textContent =
      "Nenhum plano encontrado.";
    return;
  }

  document.getElementById("planArea").innerHTML = `
    <strong>${plan.plan_name}</strong><br><br>
    <b>Entrada</b><br>
    Pago ${plan.entry_paid.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
    de ${plan.entry_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
    (${plan.entry_progress_percent}%)<br><br>

    <b>Principal</b><br>
    Pago ${plan.main_paid.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
    de ${plan.main_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
    (${plan.main_progress_percent}%)<br><br>

    <b>Geral</b><br>
    Pago ${plan.paid_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
    de ${plan.plan_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}
    (${plan.progress_percent}%)
  `;
}

boot();
</script>

</body>
</html>
