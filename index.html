<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal do Cliente</title>

  <link rel="stylesheet" href="./app.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="topbar">
        <div class="brand">
          <img id="logoImg" src="" alt="Logo">
          <div class="title">
            <strong id="companyName">Portal do Cliente</strong>
            <span id="userLine">Carregando sess√£o‚Ä¶</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnSupport">Suporte</button>
          <button class="btn btnDanger" id="btnLogout">Sair</button>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <div class="panel">
            <div class="badge"><span class="dot"></span> Seus contratos</div>
            <div class="hr"></div>

            <div id="contractsArea">
              <p class="sub">Carregando seus contratos‚Ä¶</p>
            </div>
          </div>

          <div class="panel">
            <h1 class="h1">Resumo</h1>
            <p class="sub">Vis√£o r√°pida em estilo fintech.</p>

            <div class="kv" id="summary">
              <div class="kvRow"><b>Status</b><span>‚Äî</span></div>
              <div class="kvRow"><b>Pr√≥ximo vencimento</b><span>‚Äî</span></div>
              <div class="kvRow"><b>Parcelas restantes</b><span>‚Äî</span></div>
            </div>

            <div class="hr"></div>
            <p class="small">
              Dica: voc√™ pode exibir ‚ÄúEm dia / Atrasado / Quitado‚Äù com base no vencimento.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const cfg = window.APP_CONFIG || {};
  const supabaseUrl = cfg.SUPABASE_URL;
  const supabaseKey = cfg.SUPABASE_ANON_KEY;

  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // Brand
  document.getElementById("companyName").textContent = cfg.COMPANY_NAME || "Portal do Cliente";
  document.getElementById("logoImg").src = cfg.LOGO_URL || "";

  // Support
  document.getElementById("btnSupport").onclick = () => {
    const phone = (cfg.SUPPORT_WHATSAPP || "").replace(/\D/g,'');
    const text = encodeURIComponent(cfg.SUPPORT_MESSAGE || "Ol√°! Preciso de ajuda.");
    if (!phone) return alert("Configure SUPPORT_WHATSAPP no config.js");
    window.open(`https://wa.me/${phone}?text=${text}`, "_blank");
  };

  document.getElementById("btnLogout").onclick = async () => {
    await supabase.auth.signOut();
    window.location.href = "./login.html";
  };

  function fmtMoney(v){
    const n = Number(v || 0);
    return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  }

  function statusFromDue(due){
    if(!due) return "Sem data";
    const today = new Date(); today.setHours(0,0,0,0);
    const dd = new Date(due + "T00:00:00");
    const diff = (dd - today) / 86400000;
    if (diff < 0) return "Atrasado";
    if (diff <= 5) return "Vence em breve";
    return "Em dia";
  }

  function statusBadge(status){
    const map = {
      "Em dia": "‚úÖ Em dia",
      "Vence em breve": "‚ö†Ô∏è Vence em breve",
      "Atrasado": "‚õî Atrasado",
      "Quitado": "üèÅ Quitado"
    };
    return map[status] || status;
  }

  function setSummary(status, due, remaining){
    const el = document.getElementById("summary");
    el.innerHTML = `
      <div class="kvRow"><b>Status</b><span>${statusBadge(status)}</span></div>
      <div class="kvRow"><b>Pr√≥ximo vencimento</b><span>${due || "‚Äî"}</span></div>
      <div class="kvRow"><b>Parcelas restantes</b><span>${(remaining ?? "‚Äî")}</span></div>
    `;
  }

  async function load(){
    const { data: sessionData, error: sessionErr } = await supabase.auth.getSession();
    if (sessionErr) {
      document.getElementById("contractsArea").innerHTML = `<div class="err">Erro: ${sessionErr.message}</div>`;
      return;
    }
    const session = sessionData?.session;
    if (!session) {
      window.location.href = "./login.html";
      return;
    }

    const email = session.user.email || "usu√°rio";
    document.getElementById("userLine").textContent = `Logado como: ${email}`;

    // 1) acha o client do usu√°rio
    const { data: clientRows, error: clientErr } = await supabase
      .from("clients")
      .select("id")
      .eq("user_id", session.user.id)
      .limit(1);

    if (clientErr) {
      document.getElementById("contractsArea").innerHTML = `<div class="err">Erro ao buscar cliente: ${clientErr.message}</div>`;
      return;
    }
    if (!clientRows || clientRows.length === 0) {
      document.getElementById("contractsArea").innerHTML = `<div class="err">Nenhum cliente vinculado a este usu√°rio.</div>`;
      setSummary("‚Äî", "‚Äî", "‚Äî");
      return;
    }

    const clientId = clientRows[0].id;

    // 2) busca contratos
    const { data: contracts, error: cErr } = await supabase
      .from("contracts")
      .select("amount_paid, installments_remaining, due_date, notes")
      .eq("client_id", clientId)
      .order("created_at", { ascending: false });

    if (cErr) {
      document.getElementById("contractsArea").innerHTML = `<div class="err">Erro ao buscar contratos: ${cErr.message}</div>`;
      return;
    }

    if (!contracts || contracts.length === 0) {
      document.getElementById("contractsArea").innerHTML = `<p class="sub">Nenhum contrato encontrado.</p>`;
      setSummary("‚Äî", "‚Äî", "‚Äî");
      return;
    }

    const first = contracts[0];
    const status = statusFromDue(first.due_date);
    setSummary(status, first.due_date || "‚Äî", first.installments_remaining ?? "‚Äî");

    document.getElementById("contractsArea").innerHTML = contracts.map(c => {
      const st = statusFromDue(c.due_date);
      return `
        <div class="panel" style="margin-bottom:12px; background:rgba(0,0,0,.10);">
          <div class="badge"><span class="dot"></span> ${statusBadge(st)}</div>
          <div class="hr"></div>

          <div class="kv">
            <div class="kvRow"><b>Valor pago</b><span>${fmtMoney(c.amount_paid)}</span></div>
            <div class="kvRow"><b>Parcelas restantes</b><span>${c.installments_remaining ?? "‚Äî"}</span></div>
            <div class="kvRow"><b>Vencimento</b><span>${c.due_date || "‚Äî"}</span></div>
            <div class="kvRow"><b>Observa√ß√µes</b><span>${(c.notes || "‚Äî")}</span></div>
          </div>
        </div>
      `;
    }).join("");
  }

  load();
</script>
</body>
</html>
