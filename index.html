<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal do Cliente</title>

  <link rel="stylesheet" href="./app.css?v=20260218" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js?v=1"></script>
</head>

<body>
  <div class="shell">
    <div class="card">

      <!-- TOPBAR -->
      <div class="topbar">
        <div class="brand">
          <img id="logoImg" alt="Logo" />
          <div class="title">
            <strong id="companyName">Sua empresa</strong>
            <span id="companyTagline">Acesse seus contratos</span>
            <span id="whoami" class="muted"></span>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnSupport" type="button">Suporte</button>
          <button class="btn btn-danger" id="btnLogout" type="button">Sair</button>
        </div>
      </div>

      <!-- CONTRATOS -->
      <div class="panel">
        <div class="panel-hd">
          <div class="badge"><span class="dot"></span> Seus contratos</div>
        </div>

        <div class="hr"></div>

        <div id="contractsBox" class="panel-bd">
          <div class="muted">Carregando seus contratos...</div>
        </div>
      </div>

      <!-- AÇÕES -->
     <div class="panel">
  <h2>Ações</h2>

  <div class="list">
    <a class="listItem" href="./pagamentos.html">
      <div class="liText">
        <div class="liTitle">Pagamentos</div>
        <div class="liSub">Histórico e comprovantes</div>
      </div>
      <div class="liArrow">›</div>
    </a>

    <a class="listItem" href="./perfil.html">
      <div class="liText">
        <div class="liTitle">Perfil</div>
        <div class="liSub">Seus dados cadastrais</div>
      </div>
      <div class="liArrow">›</div>
    </a>

    <a class="listItem" href="./detalhes.html">
      <div class="liText">
        <div class="liTitle">Detalhes</div>
        <div class="liSub">Contrato e informações extras</div>
      </div>
      <div class="liArrow">›</div>
    </a>
  </div>
     </div> 

<script>
(function () {
  const CFG = window.APP_CONFIG || {};
  const $ = (id) => document.getElementById(id);

  // 1) Branding seguro (não deixa logo quebrar)
  function setBrand() {
    const name = CFG.COMPANY_NAME || "Sua empresa";
    const tagline = CFG.COMPANY_TAGLINE || "Acesse seus contratos";
    $("companyName").textContent = name;
    $("companyTagline").textContent = tagline;
    $("footerCompany").textContent = name;

    const logoEl = $("logoImg");
    const preferred = (CFG.LOGO_URL || "./Logo.png");
    const fallback = preferred.includes("Logo.png") ? "./logo.png" : "./Logo.png";

    logoEl.src = preferred + "?v=1";
    logoEl.onerror = () => { logoEl.onerror = null; logoEl.src = fallback + "?v=1"; };
  }

  // 2) Cliente Supabase
  function getClient() {
    const url = CFG.SUPABASE_URL;
    const key = CFG.SUPABASE_ANON_KEY;
    if (!url || !key) throw new Error("SUPABASE_URL ou SUPABASE_ANON_KEY ausente no config.js");
    return window.supabase.createClient(url, key);
  }

  // 3) WhatsApp suporte
  function openSupport() {
    const phone = (CFG.SUPPORT_WHATSAPP || "").replace(/\D/g, "");
    const msg = encodeURIComponent(CFG.SUPPORT_MESSAGE || "Olá! Preciso de ajuda.");
    const link = phone
      ? `https://wa.me/${phone}?text=${msg}`
      : `https://wa.me/?text=${msg}`;
    window.open(link, "_blank", "noopener,noreferrer");
  }

  // 4) Render de contrato (bem separado/profissional)
  function renderContractRow(c) {
    // mapeamento tolerante de campos (porque seu banco pode estar com nomes diferentes)
    const pick = (...keys) => {
      for (const k of keys) if (c && c[k] !== undefined && c[k] !== null && String(c[k]).trim() !== "") return c[k];
      return null;
    };

    const id = pick("id", "uuid", "codigo", "code");
    const status = pick("status", "situacao", "estado") || "—";
    const paid = pick("valor_pago", "valorPago", "paid_amount", "amount_paid", "pago", "valor");
    const remaining = pick("parcelas_restantes", "parcelasRestantes", "remaining_installments", "restantes");
    const due = pick("vencimento", "proximo_vencimento", "due_date", "next_due", "data_vencimento");
    const notes = pick("observacoes", "obs", "notes", "observacao");

    const fmtMoney = (v) => {
      if (v === null || v === undefined || v === "") return "—";
      const n = Number(String(v).replace(",", "."));
      if (!Number.isFinite(n)) return String(v);
      return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    };

    const fmtDate = (v) => {
      if (!v) return "—";
      const d = new Date(v);
      if (!isNaN(d.getTime())) return d.toLocaleDateString("pt-BR");
      return String(v);
    };

    return `
      <div class="contractCard">
        <div class="contractTop">
          <div class="contractStatus">${status}</div>
          <div class="contractId">${id ? ("#" + String(id).slice(0, 8)) : ""}</div>
        </div>

        <div class="kv">
          <div class="k">Valor pago</div>
          <div class="v">${fmtMoney(paid)}</div>
        </div>

        <div class="kv">
          <div class="k">Parcelas restantes</div>
          <div class="v">${remaining ?? "—"}</div>
        </div>

        <div class="kv">
          <div class="k">Vencimento</div>
          <div class="v">${fmtDate(due)}</div>
        </div>

        <div class="kv">
          <div class="k">Observações</div>
          <div class="v">${notes ? String(notes) : "—"}</div>
        </div>
      </div>
    `;
  }

  async function loadContracts(sb, user) {
    const box = $("contractsBox");
    box.innerHTML = `<div class="muted">Carregando seus contratos...</div>`;

    // tenta tabela 1, se falhar tenta tabela 2
    const tables = ["contracts", "contratos"];
    let data = null;

    for (const table of tables) {
      try {
        const r = await sb
          .from(table)
          .select("*")
          .eq("user_id", user.id)
          .order("created_at", { ascending: false })
          .limit(10);

        if (!r.error && Array.isArray(r.data)) {
          data = r.data;
          break;
        }
      } catch (e) {
        // ignora e tenta próxima
      }
    }

    if (!data || data.length === 0) {
      box.innerHTML = `<div class="muted">Nenhum contrato encontrado.</div>`;
      return;
    }

    box.innerHTML = data.map(renderContractRow).join("");
  }

  async function main() {
    setBrand();

    const sb = getClient();

    // Botões SEMPRE depois de DOM pronto
    $("btnSupport").addEventListener("click", openSupport);

    $("btnLogout").addEventListener("click", async () => {
      try { await sb.auth.signOut(); } catch (e) {}
      // cache-buster no redirect
      window.location.href = "./login.html?v=" + Date.now();
    });

    // sessão
    const { data: sessData, error: sessErr } = await sb.auth.getSession();
    const session = sessData?.session;

    if (!session?.user) {
      window.location.href = "./login.html?v=" + Date.now();
      return;
    }

    $("whoami").textContent = `Logado como: ${session.user.email || ""}`;

    // carrega contratos
    await loadContracts(sb, session.user);
  }

  // roda depois do DOM
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => main().catch(console.error));
  } else {
    main().catch(console.error);
  }
})();
</script>
</body>
</html>
