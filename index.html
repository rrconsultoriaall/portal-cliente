<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal do Cliente</title>

  <link rel="stylesheet" href="./app.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
</head>

<body>
  <div class="shell">
    <div class="card">
      <div class="topbar">
        <div class="brand">
          <img id="logoImg" src="" alt="Logo" />
          <div class="title">
            <strong id="companyName">Portal do Cliente</strong>
            <span id="loggedAs">Carregando sessão...</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnSupport" type="button">Suporte</button>
          <button class="btn danger" id="btnLogout" type="button">Sair</button>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <!-- CONTRATOS -->
          <div class="panel">
            <div class="badge"><span class="dot"></span> Seus contratos</div>
            <div class="hr"></div>

            <div id="contractsBox">
              <div class="muted">Carregando seus contratos...</div>
            </div>
          </div>

          <!-- AÇÕES -->
          <div class="panel">
            <h2 class="h2">Ações</h2>
            <div class="muted">Abra uma seção para ver as informações completas.</div>
            <div class="hr"></div>

            <div class="navCards">
              <a class="navCard" href="./pagamentos.html">
                <div>
                  <strong>Pagamentos</strong><br />
                  <span>Histórico e comprovantes</span>
                </div>
                <div class="chev">›</div>
              </a>

              <a class="navCard" href="./perfil.html">
                <div>
                  <strong>Perfil</strong><br />
                  <span>Seus dados cadastrais</span>
                </div>
                <div class="chev">›</div>
              </a>

              <a class="navCard" href="./detalhes.html">
                <div>
                  <strong>Detalhes</strong><br />
                  <span>Contrato e informações extras</span>
                </div>
                <div class="chev">›</div>
              </a>
            </div>
          </div>
        </div>

        <div class="footer">© <span id="footerName">RR Consultoria</span></div>
      </div>
    </div>
  </div>

  <script>
    const CFG = window.APP_CONFIG || {};
    const sb = supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY);

    document.getElementById("companyName").textContent = CFG.COMPANY_NAME || "Portal do Cliente";
    document.getElementById("footerName").textContent = CFG.COMPANY_NAME || "Sua empresa";
    document.getElementById("logoImg").src = CFG.LOGO_URL || "./Logo.png";

    document.getElementById("btnSupport").addEventListener("click", () => {
      const phone = (CFG.SUPPORT_WHATSAPP || "").replace(/\D/g, "");
      const message = CFG.SUPPORT_MESSAGE || "Olá! Preciso de ajuda com o portal.";
      window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, "_blank");
    });

    document.getElementById("btnLogout").addEventListener("click", async () => {
      await sb.auth.signOut();
      window.location.href = "./login.html";
    });

    function moneyBR(value) {
      return Number(value || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }
    function formatDateBR(isoDate) {
      if (!isoDate) return "—";
      const [y,m,d] = String(isoDate).split("-");
      return (y && m && d) ? `${d}/${m}/${y}` : String(isoDate);
    }
    function statusFromDueDate(dueDate) {
      if (!dueDate) return "—";
      const today = new Date();
      const due = new Date(dueDate + "T00:00:00");
      const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      return (due < t) ? "Atrasado" : "Em dia";
    }

    async function requireSession() {
      const { data } = await sb.auth.getSession();
      if (!data?.session) {
        window.location.href = "./login.html";
        return null;
      }
      return data.session;
    }

    async function loadContracts() {
      const session = await requireSession();
      if (!session) return;

      document.getElementById("loggedAs").textContent = `Logado como: ${session.user.email || ""}`;

      const { data: clientRow } = await sb
        .from("clients")
        .select("id, full_name")
        .eq("user_id", session.user.id)
        .maybeSingle();

      // salva pra outras páginas (perfil/detalhes)
      localStorage.setItem("client_id", clientRow?.id ? String(clientRow.id) : "");
      localStorage.setItem("client_name", clientRow?.full_name || "");

      const { data: contracts, error } = await sb
        .from("contracts")
        .select("id, amount_paid, installments_remaining, due_date, notes")
        .eq("client_id", clientRow?.id || "__none__")
        .order("due_date", { ascending: true });

      if (error) {
        document.getElementById("contractsBox").innerHTML = `<div class="muted">Erro ao carregar contratos.</div>`;
        return;
      }

      if (!contracts || contracts.length === 0) {
        document.getElementById("contractsBox").innerHTML = `<div class="muted">Nenhum contrato encontrado.</div>`;
        return;
      }

      const html = contracts.map(c => {
        const st = statusFromDueDate(c.due_date);
        return `
          <div class="contractItem">
            <div class="contractHeader">
              <strong>${st}</strong>
              <span class="muted">#${String(c.id).slice(0, 8)}</span>
            </div>

            <div class="contractGrid">
              <div>
                <span class="muted">Valor pago</span>
                <div><strong>${moneyBR(c.amount_paid)}</strong></div>
              </div>

              <div>
                <span class="muted">Parcelas restantes</span>
                <div><strong>${c.installments_remaining ?? "—"}</strong></div>
              </div>

              <div>
                <span class="muted">Vencimento</span>
                <div><strong>${formatDateBR(c.due_date)}</strong></div>
              </div>

              <div>
                <span class="muted">Observações</span>
                <div><strong>${(c.notes || "—")}</strong></div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      document.getElementById("contractsBox").innerHTML = `<div class="contractsList">${html}</div>`;
    }

    loadContracts();
  </script>
</body>
</html>
