<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Portal</title>
  <link rel="stylesheet" href="./app.css?v=200">
</head>

<body>
  <div class="page">
    <div class="card">

      <header class="topbar">
        <div class="brand">
          <img id="logoImg" class="brand-logo" src="./logo.png?v=200" alt="Logo"
               onerror="this.style.display='none'">
          <div class="brand-text">
            <div id="companyName" class="brand-title">Admin</div>
            <div class="brand-tagline">Gerenciar clientes e contratos</div>
            <div id="loggedAs" class="brand-tagline mini" style="opacity:.9"></div>
          </div>
        </div>

        <div class="top-actions">
          <button class="btn btn-secondary" id="btnPortal" type="button">Portal</button>
          <button class="btn btn-danger" id="btnLogout" type="button">Sair</button>
        </div>
      </header>

      <main class="content">

        <section class="block">
          <div class="pill">Status</div>
          <div id="adminArea" class="mini">Carregando...</div>
          <div id="msg" class="msg" aria-live="polite"></div>
        </section>

        <!-- ✅ Aprovar cliente por e-mail -->
        <section class="block" id="approveBlock" style="display:none;">
          <div class="pill">Aprovar cliente</div>

          <div class="form">
            <div>
              <div class="label">E-mail do cliente</div>
              <input class="input" id="approveEmail" type="email" placeholder="cliente@email.com" />
            </div>

            <button class="btn btn-primary btn-wide" id="btnApprove" type="button">Aprovar</button>

            <div id="approveMsg" class="msg" aria-live="polite"></div>

            <div class="mini" style="opacity:.85; line-height:1.5">
              Dica: o cliente precisa ter uma linha em <b>clients</b> com esse mesmo e-mail (em minúsculo).
            </div>
          </div>
        </section>

        <!-- (Opcional, mas MUITO útil) Lista de pendentes -->
        <section class="block" id="pendingBlock" style="display:none;">
          <div class="pill">Pendentes</div>
          <div id="pendingList" class="mini">Carregando pendentes...</div>
        </section>

      </main>

      <footer class="footer">
        <span id="footerCompany">© Sua empresa</span>
      </footer>

    </div>
  </div>

  <script src="./config.js?v=200"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const CFG = window.APP_CONFIG || {};
    const sb = (window.supabase?.createClient ? window.supabase : supabase)
      .createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY);

    const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v ?? ''; };

    const msgEl = document.getElementById('msg');
    const setMsg = (t, ok=false) => {
      msgEl.textContent = t || '';
      msgEl.style.opacity = t ? '1' : '0';
      msgEl.style.color = ok ? 'rgba(86,255,180,.95)' : 'rgba(255,255,255,.82)';
    };

    // Logo + Brand
    const logoImg = document.getElementById('logoImg');
    logoImg.src = (CFG.LOGO_URL || './logo.png') + '?v=200';

    if (CFG.COMPANY_NAME) setText('companyName', `${CFG.COMPANY_NAME} • Admin`);
    setText('footerCompany', `© ${CFG.COMPANY_NAME || 'Sua empresa'}`);

    // Navegação
    document.getElementById('btnPortal').addEventListener('click', () => {
      window.location.href = './index.html';
    });

    document.getElementById('btnLogout').addEventListener('click', async () => {
      await sb.auth.signOut();
      window.location.href = './login.html';
    });

    async function requireAdmin(){
      const { data, error } = await sb.auth.getSession();
      if (error) { setMsg(error.message); return null; }

      if (!data?.session) {
        window.location.href = './login.html';
        return null;
      }

      const email = data.session.user.email || '';
      setText('loggedAs', `Logado como: ${email}`);

      const { data: adm, error: e2 } = await sb
        .from('admins')
        .select('user_id')
        .eq('user_id', data.session.user.id)
        .maybeSingle();

      if (e2) { setMsg(e2.message); return null; }

      if (!adm) {
        document.getElementById('adminArea').textContent = 'Acesso negado. Você não é admin.';
        setMsg('Sem permissão de admin.', false);
        return null;
      }

      return data.session;
    }

    // ===== Aprovar por e-mail =====
    const approveMsg = document.getElementById('approveMsg');
    const setApproveMsg = (t, ok=false) => {
      approveMsg.textContent = t || '';
      approveMsg.style.opacity = t ? '1' : '0';
      approveMsg.style.color = ok ? 'rgba(86,255,180,.95)' : 'rgba(255,255,255,.82)';
    };

    async function approveByEmail(email){
      const clean = (email || '').trim().toLowerCase();
      if (!clean) { setApproveMsg('Digite o e-mail do cliente.'); return; }

      setApproveMsg('Aprovando...');

      // Atualiza para active
      const { data, error } = await sb
        .from('clients')
        .update({ status: 'active' })
        .eq('email', clean)
        .select('email,status');

      if (error) return setApproveMsg('Erro: ' + error.message);

      if (!data || data.length === 0) {
        return setApproveMsg('Não encontrei esse e-mail na tabela clients. Verifique se o cliente salvou o perfil/cadastro.', false);
      }

      setApproveMsg('Cliente aprovado ✅', true);
      await loadPendings(); // atualiza a lista
    }

    document.getElementById('btnApprove').addEventListener('click', async () => {
      const email = document.getElementById('approveEmail').value;
      await approveByEmail(email);
    });

    // ===== Lista de pendentes (opcional) =====
    const pendingList = document.getElementById('pendingList');

    async function loadPendings(){
      pendingList.textContent = 'Carregando pendentes...';

      const { data, error } = await sb
        .from('clients')
        .select('email, full_name, status, created_at')
        .eq('status', 'pending')
        .order('created_at', { ascending: false })
        .limit(30);

      if (error) {
        pendingList.textContent = 'Erro ao carregar pendentes: ' + error.message;
        return;
      }

      if (!data || data.length === 0) {
        pendingList.innerHTML = '<div class="mini">Nenhum cliente pendente ✅</div>';
        return;
      }

      pendingList.innerHTML = data.map(row => {
        const email = (row.email || '').toLowerCase();
        const name = row.full_name || '(sem nome)';
        return `
          <div class="block" style="margin:10px 0; padding:12px;">
            <div style="font-weight:900;">${name}</div>
            <div class="mini" style="opacity:.85;">${email}</div>
            <div class="mini" style="opacity:.75;">status: ${row.status}</div>
            <div style="margin-top:10px; display:flex; gap:10px;">
              <button class="btn btn-primary" type="button" data-approve="${email}">Aprovar</button>
              <button class="btn btn-secondary" type="button" data-copy="${email}">Copiar e-mail</button>
            </div>
          </div>
        `;
      }).join('');

      // binds
      pendingList.querySelectorAll('button[data-approve]').forEach(b => {
        b.addEventListener('click', () => approveByEmail(b.getAttribute('data-approve')));
      });
      pendingList.querySelectorAll('button[data-copy]').forEach(b => {
        b.addEventListener('click', async () => {
          const em = b.getAttribute('data-copy');
          try { await navigator.clipboard.writeText(em); setApproveMsg('E-mail copiado ✅', true); }
          catch { setApproveMsg('Não consegui copiar. Copie manualmente.', false); }
        });
      });
    }

    // ===== Init =====
    (async () => {
      const session = await requireAdmin();
      if (!session) return;

      document.getElementById('adminArea').innerHTML = `
        <div class="mini" style="opacity:.9; line-height:1.6">
          ✅ Você está como admin.<br/>
          Aqui você aprova clientes e (em seguida) cria/edita contratos com segurança.
        </div>
      `;
      setMsg('Admin carregado ✅', true);

      // Mostra blocos admin
      document.getElementById('approveBlock').style.display = 'block';
      document.getElementById('pendingBlock').style.display = 'block';

      await loadPendings();
    })();
  </script>
</body>
</html>
