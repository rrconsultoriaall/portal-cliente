<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pagamentos • Área ADM</title>

  <link rel="stylesheet" href="./app.css?v=400">
  <script src="./config.js?v=400"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="page">
    <div class="card">

      <header class="topbar">
        <div class="brand">
          <img class="brand-logo" id="logoImg" src="./Logo.png" alt="Logo" onerror="this.style.display='none'">
          <div class="brand-text">
            <div class="brand-title" id="companyName">RR Consultoria</div>
            <div class="brand-sub">ADM • Pagamentos</div>
            <div class="brand-sub mini" id="loggedAs" style="opacity:.9"></div>
          </div>
        </div>

        <div class="top-actions">
          <button class="btn btn-secondary" id="btnSupport" type="button">Suporte</button>
          <button class="btn btn-danger" id="btnLogout" type="button">Sair</button>
        </div>
      </header>

      <main class="content">
        <a href="./admin.html?v=400" style="display:inline-block; margin: 0 0 10px;">&lsaquo; Voltar</a>

        <section class="block">
          <div class="pill">Pagamentos</div>
          <div id="status" class="mini" style="margin-top:10px; line-height:1.5">Carregando…</div>
          <div id="msg" class="msg" aria-live="polite" style="margin-top:12px; opacity:0"></div>
        </section>

        <section class="block" style="margin-top:12px;">
          <div class="pill">Criar pagamento</div>
          <div class="mini" style="margin-top:10px; opacity:.85">Selecione o cliente e lance o pagamento.</div>

          <div style="margin-top:10px; display:grid; gap:10px;">
            <select id="payClient" style="width:100%; padding:10px; border-radius:12px;"></select>

            <input id="payAmount" type="number" step="0.01" placeholder="Valor (ex: 2000)"
              style="width:100%; padding:10px; border-radius:12px;" />

            <input id="payDate" type="date"
              style="width:100%; padding:10px; border-radius:12px;" />

            <select id="payMethod" style="width:100%; padding:10px; border-radius:12px;">
              <option value="manual">manual</option>
              <option value="pix">pix</option>
              <option value="boleto">boleto</option>
              <option value="cartao">cartão</option>
              <option value="transferencia">transferência</option>
            </select>

            <input id="payNotes" type="text" placeholder="Obs. (opcional)"
              style="width:100%; padding:10px; border-radius:12px;" />

            <button class="btn btn-primary" id="btnCreatePayment" type="button">Lançar pagamento</button>
            <button class="btn btn-secondary" id="btnReload" type="button">Recarregar</button>
          </div>

          <div id="paymentsArea" class="mini" style="margin-top:14px; opacity:.9"></div>
        </section>
      </main>

      <footer class="footer">
        <span id="footerCompany">© RR Consultoria</span>
      </footer>

    </div>
  </div>

<script>
  const CFG = window.APP_CONFIG || {};
  const sb = (window.supabase?.createClient ? window.supabase : supabase)
    .createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  const setText = (id, v) => { const el = $(id); if (el) el.textContent = v ?? ''; };

  $('logoImg').src = CFG.LOGO_URL || './Logo.png';
  if (CFG.COMPANY_NAME) setText('companyName', CFG.COMPANY_NAME);
  setText('footerCompany', `© ${CFG.COMPANY_NAME || 'RR Consultoria'}`);

  const msgEl = $('msg');
  const setMsg = (t, ok=false) => {
    msgEl.textContent = t || '';
    msgEl.style.opacity = t ? '1' : '0';
    msgEl.style.color = ok ? 'rgba(86,255,180,.95)' : 'rgba(255,255,255,.82)';
  };

  function openSupport(){
    const phone = (CFG.SUPPORT_WHATSAPP || '').replace(/\D/g,'');
    const text  = encodeURIComponent(CFG.SUPPORT_MESSAGE || 'Olá! Preciso de ajuda com o Portal.');
    if (!phone) return alert('WhatsApp de suporte não configurado.');
    window.location.href = `https://wa.me/${phone}?text=${text}`;
  }
  $('btnSupport').addEventListener('click', openSupport);

  async function doLogout(){
    await sb.auth.signOut();
    window.location.href = './login.html?v=400';
  }
  $('btnLogout').addEventListener('click', doLogout);

  const fmtMoney = (v) => Number(v||0).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
  const fmtDate = (d) => (d ? String(d).slice(0,10) : '—');

  async function requireAdmin(session){
    const uid = session.user.id;
    const { data, error } = await sb
      .from('admins')
      .select('user_id')
      .eq('user_id', uid)
      .maybeSingle();
    if (error) throw error;
    return !!data?.user_id;
  }

  let CLIENTS = [];
  let SELECTED_CLIENT_ID = null;

  function renderClientSelect(){
    const sel = $('payClient');
    if (!CLIENTS.length) {
      sel.innerHTML = `<option value="">(sem clientes)</option>`;
      return;
    }

    sel.innerHTML = CLIENTS.map(c => {
      const label = `${c.full_name || 'Sem nome'} • ${c.email || c.user_id || c.id}`;
      return `<option value="${c.id}">${label}</option>`;
    }).join('');

    SELECTED_CLIENT_ID = CLIENTS[0].id;
    sel.value = SELECTED_CLIENT_ID;

    sel.onchange = async (e) => {
      SELECTED_CLIENT_ID = e.target.value || null;
      await loadPaymentsForClient(SELECTED_CLIENT_ID);
    };
  }

  async function loadClients(){
    const { data, error } = await sb
      .from('clients')
      .select('id, user_id, full_name, email, created_at')
      .order('created_at', { ascending: false });

    if (error) throw error;
    CLIENTS = data || [];
    renderClientSelect();
  }

  async function createPayment(){
    if (!SELECTED_CLIENT_ID) return alert('Selecione um cliente.');

    const amount = Number($('payAmount').value || 0);
    const paid_at = $('payDate').value;
    const method = $('payMethod').value || 'manual';
    const notes = $('payNotes').value || null;

    if (!amount || amount <= 0) return alert('Informe um valor válido.');
    if (!paid_at) return alert('Informe a data.');

    setMsg('Lançando pagamento...');

    const { error } = await sb
      .from('payments')
      .insert([{
        client_id: SELECTED_CLIENT_ID,
        amount,
        paid_at,
        method,
        notes
      }]);

    if (error) {
      setMsg('Erro: ' + error.message);
      return;
    }

    $('payAmount').value = '';
    $('payNotes').value = '';

    setMsg('Pagamento lançado ✅', true);
    await loadPaymentsForClient(SELECTED_CLIENT_ID);
  }

  $('btnCreatePayment').addEventListener('click', createPayment);

  async function findReceiptPath(clientId, paymentId){
    const { data: files, error } = await sb.storage
      .from('receipts')
      .list(clientId, { limit: 200 });

    if (error) throw error;

    const found = (files || []).find(f => String(f.name || '').startsWith(paymentId + '.'));
    return found?.name ? `${clientId}/${found.name}` : null;
  }

  window.openReceipt = async function(clientId, paymentId){
    try{
      setMsg('Procurando comprovante...');
      const path = await findReceiptPath(clientId, paymentId);
      if (!path) {
        setMsg('Nenhum comprovante encontrado para esse pagamento.');
        return;
      }

      const { data, error } = await sb.storage
        .from('receipts')
        .createSignedUrl(path, 60);

      if (error || !data?.signedUrl) {
        setMsg('Não consegui gerar link do comprovante.');
        return;
      }

      setMsg('Abrindo comprovante ✅', true);
      window.open(data.signedUrl, '_blank');
    } catch(e){
      console.error(e);
      setMsg('Erro ao abrir comprovante.');
    }
  };

  async function loadPaymentsForClient(clientId){
    if (!clientId) { $('paymentsArea').innerHTML = ''; return; }

    $('paymentsArea').innerHTML = 'Carregando pagamentos...';

    const { data, error } = await sb
      .from('payments')
      .select('id, amount, paid_at, method, notes, created_at')
      .eq('client_id', clientId)
      .order('paid_at', { ascending: false })
      .order('created_at', { ascending: false });

    if (error) {
      $('paymentsArea').innerHTML = 'Erro: ' + error.message;
      return;
    }

    const list = data || [];
    if (!list.length) {
      $('paymentsArea').innerHTML = `<div style="opacity:.85">Sem pagamentos para este cliente.</div>`;
      return;
    }

    $('paymentsArea').innerHTML = `
      <div class="mini" style="opacity:.85; margin-bottom:10px;">
        Pagamentos do cliente selecionado:
      </div>
      ${list.map(p => `
        <div class="block" style="margin-top:10px; background: rgba(0,0,0,.10);">
          <div class="mini" style="opacity:.8">Data</div>
          <div style="font-weight:800; margin-bottom:8px">${fmtDate(p.paid_at)}</div>

          <div class="mini" style="opacity:.8">Valor</div>
          <div style="font-weight:900; font-size:18px; margin-bottom:8px">${fmtMoney(p.amount)}</div>

          <div class="mini" style="opacity:.8">Método</div>
          <div style="margin-bottom:8px">${p.method || '—'}</div>

          <div class="mini" style="opacity:.8">Obs.</div>
          <div style="margin-bottom:10px">${p.notes ? String(p.notes) : '—'}</div>

          <button class="btn btn-secondary" type="button"
            onclick="openReceipt('${clientId}', '${p.id}')">
            Abrir comprovante
          </button>
        </div>
      `).join('')}
    `;
  }

  async function safeReload(){
    setMsg('');
    setText('status', 'Carregando...');
    $('paymentsArea').innerHTML = '';

    try{
      await loadClients();
      setText('status', `OK ✅ • ${CLIENTS.length} cliente(s)`);

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      $('payDate').value = `${yyyy}-${mm}-${dd}`;

      if (SELECTED_CLIENT_ID) await loadPaymentsForClient(SELECTED_CLIENT_ID);
    } catch(e){
      console.error(e);
      setText('status', 'Erro ao carregar.');
      setMsg(e?.message || 'Erro desconhecido.');
      $('paymentsArea').innerHTML = `<div style="opacity:.85">Erro ao carregar pagamentos.</div>`;
    }
  }

  $('btnReload').addEventListener('click', safeReload);

  async function boot(){
    setMsg('');

    const { data: sessData, error: sessErr } = await sb.auth.getSession();
    if (sessErr) {
      setText('status', 'Erro de sessão.');
      setMsg(sessErr.message);
      window.location.href = './login.html?v=400';
      return;
    }

    const session = sessData?.session;
    if (!session) {
      window.location.href = './login.html?v=400';
      return;
    }

    const email = session.user.email;
    setText('loggedAs', email ? `Logado como: ${email}` : '');

    try{
      const ok = await requireAdmin(session);
      if (!ok) {
        setText('status', 'Você não tem permissão de ADM.');
        setMsg('Acesso negado.');
        window.location.href = './index.html?v=400';
        return;
      }
    } catch(e){
      console.error(e);
      setText('status', 'Erro ao validar ADM.');
      setMsg(e.message || 'Erro.');
      return;
    }

    await safeReload();
  }

  boot();
</script>

</body>
              </html>
