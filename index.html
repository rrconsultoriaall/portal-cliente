<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal do Cliente</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f4f6f9;text-align:center;padding:40px}
    h1{color:#1e40af;margin:0 0 18px}
    .wrap{max-width:760px;margin:0 auto}
    .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);text-align:left}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .pill{display:inline-block;background:#f3f4f6;padding:6px 10px;border-radius:999px;font-size:12px;color:#111827}
    .btn{border:0;border-radius:10px;background:#111827;color:#fff;padding:10px 12px;cursor:pointer;font-weight:700}
    .muted{color:#6b7280;font-size:13px}
    .err{color:#b91c1c;font-size:13px;margin-top:10px}
    .list{margin-top:12px;display:grid;gap:10px}
    .item{border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .k{font-size:12px;color:#6b7280}
    .v{font-size:14px;color:#111827;font-weight:700}
    .loading{display:inline-block;background:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Portal do Cliente</h1>

    <div class="card">
      <div class="top">
        <div>
          <div class="pill" id="who">Carregando…</div>
          <div class="muted" id="subtitle">Buscando seus contratos…</div>
        </div>
        <button class="btn" id="logoutBtn">Sair</button>
      </div>

      <div id="content">
        <span class="loading">Carregando…</span>
      </div>

      <div id="error" class="err"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ✅ Coloque suas chaves aqui
    const supabaseUrl = "https://occxmqvoyvmxvaoaxecw.supabase.co";
    const supabaseKey = "SUA_ANON_KEY_AQUI";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const $ = (id) => document.getElementById(id);
    const setErr = (t) => $("error").textContent = t || "";

    function money(v){
      if (v === null || v === undefined || v === "") return "-";
      const n = Number(v);
      if (Number.isNaN(n)) return String(v);
      return n.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
    }

    function fmtDate(d){
      if (!d) return "-";
      try {
        const dt = new Date(d);
        return dt.toLocaleDateString("pt-BR");
      } catch {
        return String(d);
      }
    }

    async function logout(){
      await supabase.auth.signOut();
      location.href = "./login.html";
    }

    $("logoutBtn").addEventListener("click", logout);

    async function loadPortal(){
      setErr("");

      // 1) Sessão
      const { data: { session }, error: sessErr } = await supabase.auth.getSession();
      if (sessErr) {
        setErr("Erro sessão: " + sessErr.message);
        return;
      }
      if (!session) {
        location.href = "./login.html";
        return;
      }

      // 2) Usuário
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if (userErr) {
        setErr("Erro ao ler usuário: " + userErr.message);
        return;
      }
      if (!user) {
        location.href = "./login.html";
        return;
      }

      $("who").textContent = user.email || "Usuário logado";

      // 3) Pega o client do usuário (public.clients.user_id = auth.users.id)
      const { data: client, error: clientErr } = await supabase
        .from("clients")
        .select("id, full_name, user_id")
        .eq("user_id", user.id)
        .maybeSingle();

      if (clientErr) {
        setErr("Erro ao buscar cliente: " + clientErr.message);
        return;
      }

      if (!client) {
        $("subtitle").textContent = "Seu cadastro de cliente ainda não foi criado.";
        $("content").innerHTML = "<div class='muted'>Nenhum registro em <b>clients</b> para este usuário.</div>";
        return;
      }

      $("who").textContent = (client.full_name && client.full_name.trim())
        ? client.full_name
        : (user.email || "Cliente");

      $("subtitle").textContent = "Cliente ID: " + client.id;

      // 4) Busca contratos do cliente
      const { data: contracts, error: conErr } = await supabase
        .from("contracts")
        .select("id, created_at, client_id, amount_paid, installment, due_date, notes")
        .eq("client_id", client.id)
        .order("created_at", { ascending: false });

      if (conErr) {
        setErr("Erro ao buscar contratos: " + conErr.message);
        return;
      }

      if (!contracts || contracts.length === 0) {
        $("content").innerHTML = "<div class='muted'>Nenhum contrato encontrado para este cliente.</div>";
        return;
      }

      // 5) Render
      const html = `
        <div class="list">
          ${contracts.map(c => `
            <div class="item">
              <div class="row">
                <div>
                  <div class="k">Contrato</div>
                  <div class="v">${c.id}</div>
                </div>
                <div>
                  <div class="k">Vencimento</div>
                  <div class="v">${fmtDate(c.due_date)}</div>
                </div>
              </div>

              <div class="row" style="margin-top:10px">
                <div>
                  <div class="k">Valor pago</div>
                  <div class="v">${money(c.amount_paid)}</div>
                </div>
                <div>
                  <div class="k">Parcela</div>
                  <div class="v">${(c.installment ?? "-")}</div>
                </div>
              </div>

              <div style="margin-top:10px">
                <div class="k">Observações</div>
                <div class="v" style="font-weight:400">${c.notes ? c.notes : "-"}</div>
              </div>
            </div>
          `).join("")}
        </div>
      `;

      $("content").innerHTML = html;
    }

    loadPortal();
  </script>
</body>
  </html>
