<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pagamentos</title>

  <link rel="stylesheet" href="./app.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
</head>
<body>
  <div class="bg"></div>

  <div class="shell">
    <header class="topbar">
      <div class="brand">
        <img id="logoImg" class="logo" alt="Logo" />
        <div class="brandText">
          <div class="brandName" id="companyName">Pagamentos</div>
          <div class="brandSub">Próximos vencimentos e status</div>
        </div>
      </div>

      <div class="topActions">
        <button type="button" class="btn ghost" id="btnSupport">Suporte</button>
        <button type="button" class="btn" id="btnBack">Voltar</button>
      </div>
    </header>

    <main class="content">
      <section class="card">
        <div class="cardHead">
          <span class="dot"></span>
          <h2>Agenda</h2>
        </div>

        <div id="list" class="stack"></div>
        <div id="empty" class="muted" style="display:none;">Nada por aqui ainda.</div>
      </section>
    </main>

    <nav class="bottomNav">
      <button type="button" class="navItem" data-go="./index.html">Painel</button>
      <button type="button" class="navItem active" data-go="./pagamentos.html">Pagamentos</button>
      <button type="button" class="navItem" data-go="./perfil.html">Perfil</button>
    </nav>

    <footer class="footer">© <span id="companyFooter">Sua empresa</span></footer>
  </div>

  <script>
    const CFG = window.APP_CONFIG || {};
    const supabase = window.supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY);
    const $ = (id) => document.getElementById(id);

    function moneyBR(v) {
      const n = Number(v || 0);
      return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }
    function dateBR(iso) {
      if (!iso) return "—";
      const d = new Date(iso + "T00:00:00");
      return d.toLocaleDateString("pt-BR");
    }
    function statusContrato(dueISO, instRem) {
      const inst = Number(instRem ?? 0);
      if (inst <= 0) return "Quitado";
      if (!dueISO) return "Em dia";
      const today = new Date();
      const due = new Date(dueISO + "T00:00:00");
      return (due < new Date(today.getFullYear(), today.getMonth(), today.getDate())) ? "Atrasado" : "Em dia";
    }
    function badgeClass(status) {
      if (status === "Quitado") return "badge ok";
      if (status === "Atrasado") return "badge warn";
      return "badge";
    }
    function openSupport(extra) {
      const phone = (CFG.SUPPORT_WHATSAPP || "").replace(/\D/g, "");
      const base = CFG.SUPPORT_MESSAGE || "Olá! Preciso de ajuda no Portal do Cliente.";
      const msg = extra ? `${base}\n\n${extra}` : base;
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank", "noopener,noreferrer");
    }

    async function requireSession() {
      const { data } = await supabase.auth.getSession();
      const session = data?.session;
      if (!session) { location.href = "./login.html"; return null; }
      return session;
    }

    async function load() {
      $("logoImg").src = CFG.LOGO_URL || "./Logo.png";
      $("companyName").textContent = CFG.COMPANY_NAME || "RR Consultoria";
      $("companyFooter").textContent = CFG.COMPANY_NAME || "Sua empresa";

      document.querySelectorAll(".navItem").forEach(btn => btn.addEventListener("click", () => location.href = btn.dataset.go));
      $("btnBack").addEventListener("click", () => history.length > 1 ? history.back() : (location.href = "./index.html"));
      $("btnSupport").addEventListener("click", () => openSupport("Tela: Pagamentos"));

      const session = await requireSession();
      if (!session) return;

      const { data: client } = await supabase
        .from("clients")
        .select("id")
        .eq("user_id", session.user.id)
        .maybeSingle();

      if (!client) {
        $("list").innerHTML = `<div class="error">Seu usuário não está vinculado a um cliente (tabela clients).</div>`;
        return;
      }

      const { data: contracts, error } = await supabase
        .from("contracts")
        .select("id, due_date, installments_remaining, amount_paid, notes, created_at")
        .eq("client_id", client.id)
        .order("due_date", { ascending: true });

      if (error) {
        $("list").innerHTML = `<div class="error">Erro: ${error.message}</div>`;
        return;
      }

      if (!contracts || contracts.length === 0) {
        $("empty").style.display = "block";
        return;
      }

      $("list").innerHTML = "";
      contracts.forEach(c => {
        const st = statusContrato(c.due_date, c.installments_remaining);
        const item = document.createElement("div");
        item.className = "payItem";
        item.innerHTML = `
          <div class="row" style="justify-content: space-between;">
            <div class="${badgeClass(st)}">${st}</div>
            <div class="muted mono">#${String(c.id).slice(0, 8)}</div>
          </div>

          <div class="kvGrid compact">
            <div class="kv"><div class="k">Vencimento</div><div class="v">${dateBR(c.due_date)}</div></div>
            <div class="kv"><div class="k">Parcelas restantes</div><div class="v">${c.installments_remaining ?? "—"}</div></div>
            <div class="kv"><div class="k">Valor pago</div><div class="v">${moneyBR(c.amount_paid)}</div></div>
          </div>

          <div class="actionsRow">
            <button type="button" class="btn small" data-details="${c.id}">Detalhes</button>
            <button type="button" class="btn small ghost" data-support="${c.id}">Suporte</button>
          </div>
        `;
        $("list").appendChild(item);
      });

      document.querySelectorAll("[data-details]").forEach(btn => {
        btn.addEventListener("click", () => {
          localStorage.setItem("selected_contract_id", btn.dataset.details);
          location.href = "./detalhes.html";
        });
      });
      document.querySelectorAll("[data-support]").forEach(btn => {
        btn.addEventListener("click", () => openSupport(`Contrato: ${btn.dataset.support}`));
      });
    }

    document.addEventListener("DOMContentLoaded", load);
  </script>
</body>
</html>
