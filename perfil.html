<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Perfil • Portal do Cliente</title>
  <link rel="stylesheet" href="./app.css?v=200">
  <script src="./config.js?v=99"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="page">
    <div class="card">

      <header class="topbar">
        <div class="brand">
          <img class="brand-logo" id="logoImg" src="./Logo.png" alt="Logo" onerror="this.style.display='none'">
          <div class="brand-text">
            <div class="brand-title" id="companyName">RR Consultoria</div>
            <div class="brand-sub" id="companyTagline">Assessoria &amp; Consultoria</div>
            <div class="brand-sub mini" id="loggedAs" style="opacity:.9"></div>
          </div>
        </div>

        <div class="top-actions">
          <button class="btn btn-secondary" id="btnSupport" type="button">Suporte</button>
          <button class="btn btn-danger" id="btnLogout" type="button">Sair</button>
        </div>
      </header>

      <main class="content">

        <a href="./index.html?v=200" style="display:inline-block; margin: 2px 0 12px;">&larr; Voltar</a>

        <section class="block">
          <div class="pill">Seus dados</div>

          <div id="statusLine" class="mini" style="line-height:1.55; margin-bottom:10px;">
            Carregando...
          </div>

          <div id="msg" class="msg" aria-live="polite" style="opacity:0;"></div>

          <form id="profileForm" autocomplete="on" style="margin-top:10px;">

            <label for="full_name">Nome completo</label>
            <input id="full_name" name="full_name" type="text" placeholder="Seu nome completo" />

            <label for="birth_date">Data de nascimento</label>
            <input id="birth_date" name="birth_date" type="date" />

            <label for="cpf">CPF</label>
            <input id="cpf" name="cpf" type="text" inputmode="numeric" placeholder="Somente números" />

            <label for="phone">Telefone</label>
            <input id="phone" name="phone" type="text" inputmode="tel" placeholder="DDD + número" />

            <label for="cep">CEP</label>
            <input id="cep" name="cep" type="text" inputmode="numeric" placeholder="Somente números" />

            <label for="address">Endereço</label>
            <input id="address" name="address" type="text" placeholder="Rua, número, bairro" />

            <label for="city">Cidade</label>
            <input id="city" name="city" type="text" placeholder="Sua cidade" />

            <label for="state">Estado</label>
            <select id="state" name="state">
              <option value="">Selecione</option>
              <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option><option>CE</option>
              <option>DF</option><option>ES</option><option>GO</option><option>MA</option><option>MT</option><option>MS</option>
              <option>MG</option><option>PA</option><option>PB</option><option>PR</option><option>PE</option><option>PI</option>
              <option>RJ</option><option>RN</option><option>RS</option><option>RO</option><option>RR</option><option>SC</option>
              <option>SP</option><option>SE</option><option>TO</option>
            </select>

            <label for="notes">Observações</label>
            <textarea id="notes" name="notes" rows="3" placeholder="Opcional"></textarea>

            <div class="actions">
              <button class="btn btn-primary" id="btnSave" type="submit">Salvar</button>
              <button class="btn btn-secondary" id="btnReload" type="button">Recarregar</button>
            </div>

          </form>
        </section>

      </main>

      <footer class="footer">
        <span id="footerCompany">© RR Consultoria</span>
      </footer>

    </div>
  </div>

<script>
  // ===== Config / Supabase =====
  const CFG = window.APP_CONFIG || {};
  const sb = (window.supabase?.createClient ? window.supabase : supabase)
    .createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);

  const setText = (id, v) => { const el = $(id); if (el) el.textContent = v ?? ''; };

  const msgEl = $('msg');
  const setMsg = (t, ok=false) => {
    msgEl.textContent = t || '';
    msgEl.style.opacity = t ? '1' : '0';
    msgEl.style.color = ok ? 'rgba(86,255,180,.95)' : 'rgba(255,255,255,.82)';
  };

  // Branding
  $('logoImg').src = CFG.LOGO_URL || './Logo.png';
  if (CFG.COMPANY_NAME) setText('companyName', CFG.COMPANY_NAME);
  if (CFG.COMPANY_TAGLINE) setText('companyTagline', CFG.COMPANY_TAGLINE);
  setText('footerCompany', `© ${CFG.COMPANY_NAME || 'RR Consultoria'}`);

  // Suporte WhatsApp
  function openSupport(){
    const phone = (CFG.SUPPORT_WHATSAPP || '').replace(/\D/g,'');
    const text  = encodeURIComponent(CFG.SUPPORT_MESSAGE || 'Olá! Preciso de ajuda com o Portal do Cliente.');
    if (!phone) return alert('WhatsApp de suporte não configurado.');
    window.location.href = `https://wa.me/${phone}?text=${text}`;
  }
  $('btnSupport').addEventListener('click', openSupport);

  // Logout
  async function doLogout(){
    await sb.auth.signOut();
    window.location.href = './login.html?v=200';
  }
  $('btnLogout').addEventListener('click', doLogout);

  // ===== Helpers de formatação (sem frescura) =====
  const onlyDigits = (s) => (s ?? '').toString().replace(/\D/g,'');
  function normalizeState(v){
    const s = (v ?? '').toString().trim().toUpperCase();
    return s.length === 2 ? s : (s ? s.slice(0,2) : '');
  }

  // ===== Load/Save =====
  let CURRENT_UID = null;

  function fillForm(client){
    // client pode ser null
    $('full_name').value = client?.full_name ?? '';
    $('birth_date').value = client?.birth_date ? String(client.birth_date).slice(0,10) : '';
    $('cpf').value = client?.cpf ?? '';
    $('phone').value = client?.phone ?? '';
    $('cep').value = client?.cep ?? '';
    $('address').value = client?.address ?? '';
    $('city').value = client?.city ?? '';
    $('state').value = client?.state ? normalizeState(client.state) : '';
    $('notes').value = client?.notes ?? '';
  }

  async function loadClient(){
    setMsg('');
    $('statusLine').textContent = 'Carregando...';

    const { data: sessData } = await sb.auth.getSession();
    const session = sessData?.session;
    if (!session) {
      window.location.href = './login.html?v=200';
      return;
    }

    const uid = session.user.id;
    const email = session.user.email;
    CURRENT_UID = uid;
    setText('loggedAs', email ? `Logado como: ${email}` : '');

    // Busca pelo user_id (regra correta)
    const { data: client, error } = await sb
      .from('clients')
      .select('id,user_id,is_active,full_name,birth_date,cpf,phone,cep,address,city,state,notes,email,status,plan_id,created_at')
      .eq('user_id', uid)
      .maybeSingle();

    if (error) {
      $('statusLine').textContent = 'Erro ao carregar seu perfil.';
      setMsg(error.message);
      fillForm(null);
      return;
    }

    if (!client) {
      // Se não existir, a gente avisa (mas não cria automaticamente pra não “inventar” regra)
      $('statusLine').innerHTML = `
        Não encontramos seu cadastro na tabela <b>clients</b>.<br/>
        Fale com o suporte para criar/associar seu usuário.
      `;
      setMsg('Cadastro não encontrado para este usuário.', false);
      fillForm(null);
      return;
    }

    // ok
    $('statusLine').innerHTML = `Perfil carregado ✅`;
    fillForm(client);
    setMsg('', true);
  }

  async function saveClient(){
    setMsg('');

    if (!CURRENT_UID) {
      setMsg('Sessão inválida. Faça login novamente.');
      return;
    }

    // monta payload com as colunas reais da sua tabela
    const payload = {
      full_name: ($('full_name').value || '').trim() || null,
      birth_date: $('birth_date').value ? $('birth_date').value : null,
      cpf: onlyDigits($('cpf').value) || null,
      phone: ($('phone').value || '').trim() || null,
      cep: onlyDigits($('cep').value) || null,
      address: ($('address').value || '').trim() || null,
      city: ($('city').value || '').trim() || null,
      state: normalizeState($('state').value) || null,
      notes: ($('notes').value || '').trim() || null,
    };

    // Atualiza o registro do cliente pelo user_id
    const { data, error } = await sb
      .from('clients')
      .update(payload)
      .eq('user_id', CURRENT_UID)
      .select('id')
      .maybeSingle();

    if (error) {
      setMsg(`Erro ao salvar: ${error.message}`);
      return;
    }

    if (!data) {
      setMsg('Não foi possível salvar: cadastro não encontrado para este usuário.');
      return;
    }

    setMsg('Dados salvos ✅', true);
  }

  // Eventos
  $('btnReload').addEventListener('click', loadClient);

  $('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    $('btnSave').disabled = true;
    try {
      await saveClient();
    } finally {
      $('btnSave').disabled = false;
    }
  });

  // Boot
  loadClient();
</script>

</body>
</html>
```0
