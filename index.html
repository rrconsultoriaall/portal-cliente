<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal do Cliente</title>

  <link rel="stylesheet" href="./app.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
</head>
<body>
  <div class="bg"></div>

  <div class="shell">
    <header class="topbar">
      <div class="brand">
        <img id="logoImg" class="logo" alt="Logo" />
        <div class="brandText">
          <div class="brandName" id="companyName">Portal do Cliente</div>
          <div class="brandSub" id="whoami">Carregando sess√£o‚Ä¶</div>
        </div>
      </div>

      <div class="topActions">
        <button type="button" class="btn ghost" id="btnSupport">Suporte</button>
        <button type="button" class="btn danger" id="btnLogout">Sair</button>
      </div>
    </header>

    <main class="content">
      <section class="card">
        <div class="cardHead">
          <span class="dot"></span>
          <h2>Seus contratos</h2>
        </div>
        <div id="contractsWrap" class="contracts"></div>
        <div id="emptyState" class="muted" style="display:none;">Nenhum contrato encontrado para este usu√°rio.</div>
      </section>

      <section class="card">
        <div class="cardHead">
          <span class="dot"></span>
          <h2>Resumo</h2>
        </div>

        <div class="kvGrid">
          <div class="kv">
            <div class="k">Status</div>
            <div class="v" id="sumStatus">‚Äî</div>
          </div>
          <div class="kv">
            <div class="k">Pr√≥ximo vencimento</div>
            <div class="v" id="sumDue">‚Äî</div>
          </div>
          <div class="kv">
            <div class="k">Parcelas restantes</div>
            <div class="v" id="sumInst">‚Äî</div>
          </div>
          <div class="kv">
            <div class="k">Valor pago</div>
            <div class="v" id="sumPaid">‚Äî</div>
          </div>
        </div>

        <div class="hint">üí° Dica: ‚ÄúEm dia / Atrasado / Quitado‚Äù √© calculado automaticamente pelo vencimento e parcelas.</div>
      </section>
    </main>

    <nav class="bottomNav">
      <button type="button" class="navItem active" data-go="./index.html">Painel</button>
      <button type="button" class="navItem" data-go="./pagamentos.html">Pagamentos</button>
      <button type="button" class="navItem" data-go="./perfil.html">Perfil</button>
    </nav>

    <footer class="footer">¬© <span id="companyFooter">Sua empresa</span></footer>
  </div>

  <script>
    const CFG = window.APP_CONFIG || {};
    const supabase = window.supabase.createClient(CFG.SUPABASE_URL, CFG.SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);

    function moneyBR(v) {
      const n = Number(v || 0);
      return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }
    function dateBR(iso) {
      if (!iso) return "‚Äî";
      const d = new Date(iso + "T00:00:00");
      return d.toLocaleDateString("pt-BR");
    }
    function statusContrato(dueISO, instRem) {
      const inst = Number(instRem ?? 0);
      if (inst <= 0) return "Quitado";
      if (!dueISO) return "Em dia";
      const today = new Date();
      const due = new Date(dueISO + "T00:00:00");
      return (due < new Date(today.getFullYear(), today.getMonth(), today.getDate())) ? "Atrasado" : "Em dia";
    }
    function badgeClass(status) {
      if (status === "Quitado") return "badge ok";
      if (status === "Atrasado") return "badge warn";
      return "badge";
    }

    function openSupport(extra) {
      const phone = (CFG.SUPPORT_WHATSAPP || "").replace(/\D/g, "");
      const base = CFG.SUPPORT_MESSAGE || "Ol√°! Preciso de ajuda no Portal do Cliente.";
      const msg = extra ? `${base}\n\n${extra}` : base;
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank", "noopener,noreferrer");
    }

    async function requireSession() {
      const { data } = await supabase.auth.getSession();
      const session = data?.session;
      if (!session) {
        location.href = "./login.html";
        return null;
      }
      return session;
    }

    async function load() {
      // Marca
      $("logoImg").src = CFG.LOGO_URL || "./Logo.png";
      $("companyName").textContent = CFG.COMPANY_NAME || "Portal do Cliente";
      $("companyFooter").textContent = CFG.COMPANY_NAME || "Sua empresa";

      // Nav
      document.querySelectorAll(".navItem").forEach(btn => {
        btn.addEventListener("click", () => location.href = btn.dataset.go);
      });

      // Bot√µes topo
      $("btnSupport").addEventListener("click", () => openSupport(`Tela: Painel`));
      $("btnLogout").addEventListener("click", async () => {
        await supabase.auth.signOut();
        location.href = "./login.html";
      });

      const session = await requireSession();
      if (!session) return;

      $("whoami").textContent = `Logado como: ${session.user.email}`;

      // Buscar client pelo user_id
      const { data: client, error: e1 } = await supabase
        .from("clients")
        .select("id, full_name")
        .eq("user_id", session.user.id)
        .maybeSingle();

      if (e1) {
        $("contractsWrap").innerHTML = `<div class="error">Erro ao buscar cliente: ${e1.message}</div>`;
        return;
      }
      if (!client) {
        $("contractsWrap").innerHTML = `<div class="error">Seu usu√°rio n√£o est√° vinculado a um cliente (tabela clients).</div>`;
        return;
      }

      // Buscar contratos do client
      const { data: contracts, error: e2 } = await supabase
        .from("contracts")
        .select("id, amount_paid, installments_remaining, due_date, notes, created_at")
        .eq("client_id", client.id)
        .order("created_at", { ascending: false });

      if (e2) {
        $("contractsWrap").innerHTML = `<div class="error">Erro ao buscar contratos: ${e2.message}</div>`;
        return;
      }

      if (!contracts || contracts.length === 0) {
        $("emptyState").style.display = "block";
        return;
      }

      // Render lista (cards clic√°veis)
      $("contractsWrap").innerHTML = "";
      contracts.forEach((c) => {
        const st = statusContrato(c.due_date, c.installments_remaining);
        const el = document.createElement("div");
        el.className = "contractCard";
        el.innerHTML = `
          <div class="row">
            <div class="${badgeClass(st)}">${st}</div>
            <div class="muted mono">#${String(c.id).slice(0, 8)}</div>
          </div>

          <div class="kvGrid compact">
            <div class="kv"><div class="k">Valor pago</div><div class="v">${moneyBR(c.amount_paid)}</div></div>
            <div class="kv"><div class="k">Parcelas restantes</div><div class="v">${c.installments_remaining ?? "‚Äî"}</div></div>
            <div class="kv"><div class="k">Vencimento</div><div class="v">${dateBR(c.due_date)}</div></div>
          </div>

          <div class="note">${(c.notes || "").trim() ? c.notes : "‚Äî sem observa√ß√µes ‚Äî"}</div>

          <div class="actionsRow">
            <button type="button" class="btn small" data-details="${c.id}">Ver detalhes</button>
            <button type="button" class="btn small ghost" data-support="${c.id}">Falar no suporte</button>
          </div>
        `;
        $("contractsWrap").appendChild(el);
      });

      // Handlers de bot√µes dentro da lista
      document.querySelectorAll("[data-details]").forEach(btn => {
        btn.addEventListener("click", () => {
          localStorage.setItem("selected_contract_id", btn.dataset.details);
          location.href = "./detalhes.html";
        });
      });

      document.querySelectorAll("[data-support]").forEach(btn => {
        btn.addEventListener("click", () => openSupport(`Contrato: ${btn.dataset.support}`));
      });

      // Resumo = primeiro contrato da lista
      const first = contracts[0];
      const st0 = statusContrato(first.due_date, first.installments_remaining);
      $("sumStatus").textContent = st0;
      $("sumDue").textContent = dateBR(first.due_date);
      $("sumInst").textContent = first.installments_remaining ?? "‚Äî";
      $("sumPaid").textContent = moneyBR(first.amount_paid);
    }

    document.addEventListener("DOMContentLoaded", load);
  </script>
</body>
</html>
