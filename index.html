<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal do Cliente</title>

  <link rel="stylesheet" href="./app.css?v=20260218a" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Seu config -->
  <script src="./config.js?v=20260218a"></script>
</head>

<body>
  <div class="shell">
    <div class="card">
      <!-- TOPBAR -->
      <div class="topbar">
        <div class="brand">
          <img id="logoImg" src="" alt="Logo" />
          <div class="title">
            <strong id="companyName">Sua empresa</strong>
            <span id="companyTagline">Acesse seus contratos</span>
            <span id="loggedAs" class="muted" style="display:none;"></span>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnSupport" type="button">Suporte</button>
          <button class="btn btn-ghost" id="btnLogout" type="button">Sair</button>
        </div>
      </div>

      <!-- CONTENT -->
      <div class="content">

        <!-- CONTRATOS -->
        <div class="panel">
          <div class="panelHead">
            <span class="pill">Seus contratos</span>
          </div>

          <div id="contractsBox" class="contractBox">
            <div id="contractsStatus" class="muted">Carregando seus contratos...</div>
            <div id="contractsList"></div>
          </div>

          <div id="errBox" class="err" style="display:none;"></div>
        </div>

        <!-- AÇÕES -->
        <div class="panel">
          <div class="panelHead">
            <h2 style="margin:0;">Ações</h2>
          </div>

          <div class="menu">
            <a class="menuItem" href="./pagamentos.html">
              <div class="miText">
                <strong>Pagamentos</strong>
                <span>Histórico e comprovantes</span>
              </div>
              <span class="miArrow">›</span>
            </a>

            <a class="menuItem" href="./perfil.html">
              <div class="miText">
                <strong>Perfil</strong>
                <span>Seus dados cadastrais</span>
              </div>
              <span class="miArrow">›</span>
            </a>

            <a class="menuItem" href="./detalhes.html">
              <div class="miText">
                <strong>Detalhes</strong>
                <span>Contrato e informações extras</span>
              </div>
              <span class="miArrow">›</span>
            </a>
          </div>
        </div>

        <div class="footer">© <span id="footerCompany">Sua empresa</span></div>
      </div>
    </div>
  </div>

  <script>
    // ========= Config + UI =========
    const CFG = window.APP_CONFIG || {};
    const $ = (id) => document.getElementById(id);

    $("companyName").textContent = CFG.COMPANY_NAME || "Sua empresa";
    $("companyTagline").textContent = CFG.COMPANY_TAGLINE || "Acesse seus contratos";
    $("footerCompany").textContent = CFG.COMPANY_NAME || "Sua empresa";

    if (CFG.LOGO_URL) $("logoImg").src = CFG.LOGO_URL;

    // ========= Supabase =========
    const supabase = window.supabase.createClient(
      CFG.SUPABASE_URL,
      CFG.SUPABASE_ANON_KEY
    );

    // ========= Helpers =========
    function showError(msg) {
      const box = $("errBox");
      box.style.display = "block";
      box.textContent = msg;
    }

    function moneyBRL(n) {
      try {
        return new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(Number(n || 0));
      } catch {
        return `R$ ${n}`;
      }
    }

    function dateBR(d) {
      if (!d) return "—";
      // aceita YYYY-MM-DD
      const parts = String(d).slice(0,10).split("-");
      if (parts.length !== 3) return String(d);
      return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    function renderContract(c) {
      // ajuste os nomes abaixo se a sua tabela usa outros campos
      const status = c.status || "—";
      const id = c.id ? `#${String(c.id).slice(0,8)}` : "";
      const paid = moneyBRL(c.valor_pago ?? c.valorPago ?? 0);
      const rest = (c.parcelas_restantes ?? c.parcelasRestantes ?? "—");
      const venc = dateBR(c.vencimento);
      const obs = (c.observacoes ?? c.obs ?? "—");

      return `
        <div class="contractCard">
          <div class="ccTop">
            <div class="ccStatus">${status}</div>
            <div class="ccId">${id}</div>
          </div>

          <div class="ccGrid">
            <div class="ccRow">
              <span class="ccLabel">Valor pago</span>
              <strong class="ccValue">${paid}</strong>
            </div>

            <div class="ccRow">
              <span class="ccLabel">Parcelas restantes</span>
              <strong class="ccValue">${rest}</strong>
            </div>

            <div class="ccRow">
              <span class="ccLabel">Vencimento</span>
              <strong class="ccValue">${venc}</strong>
            </div>

            <div class="ccRow ccFull">
              <span class="ccLabel">Observações</span>
              <strong class="ccValue">${obs}</strong>
            </div>
          </div>
        </div>
      `;
    }

    // ========= Actions =========
    $("btnSupport").addEventListener("click", () => {
      const phone = (CFG.SUPPORT_WHATSAPP || "").replace(/\D/g, "");
      const msg = encodeURIComponent(CFG.SUPPORT_MESSAGE || "Olá! Preciso de ajuda.");
      if (!phone) return alert("WhatsApp de suporte não configurado no config.js");
      window.open(`https://wa.me/${phone}?text=${msg}`, "_blank");
    });

    $("btnLogout").addEventListener("click", async () => {
      await supabase.auth.signOut();
      // joga pro login
      window.location.href = "./login.html?v=20260218a";
    });

    // ========= Load =========
    (async function init() {
      try {
        const { data: sessionData, error: sessErr } = await supabase.auth.getSession();
        if (sessErr) throw sessErr;

        const session = sessionData?.session;
        if (!session) {
          window.location.href = "./login.html?v=20260218a";
          return;
        }

        const email = session.user?.email || "";
        $("loggedAs").style.display = "block";
        $("loggedAs").textContent = `Logado como: ${email}`;

        // >>>>>>>>>>>> BUSCA DE CONTRATOS <<<<<<<<<<<<
        // Troque "contracts" pelo nome real da sua tabela se for diferente
        // E troque "email" pelo campo certo (ex: client_email, user_email, etc.)
        const { data: rows, error: qErr } = await supabase
          .from("contracts")
          .select("*")
          .eq("email", email)
          .order("created_at", { ascending: false })
          .limit(10);

        if (qErr) throw qErr;

        $("contractsStatus").style.display = "none";
        const list = $("contractsList");

        if (!rows || rows.length === 0) {
          list.innerHTML = `<div class="muted">Nenhum contrato encontrado.</div>`;
          return;
        }

        list.innerHTML = rows.map(renderContract).join("");

      } catch (e) {
        $("contractsStatus").style.display = "none";
        showError("Erro ao carregar contratos: " + (e?.message || e));
      }
    })();
  </script>

  <!-- CSS mínimo local para garantir o botão Sair + cards bonitos (SEM mexer na paleta) -->
  <style>
    /* garante alinhamento dos botões no topo */
    .actions { display:flex; gap:12px; align-items:center; }
    .btn { cursor:pointer; }

    /* botão Sair “padronizado” sem virar vermelho/estranho */
    .btn-ghost{
      opacity:.95;
    }

    /* lista/itens (ações) */
    .menu { display:flex; flex-direction:column; gap:14px; margin-top:14px; }
    .menuItem{
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      text-decoration:none;
      color: rgba(255,255,255,.92);
    }
    .miText strong{ display:block; font-size:18px; }
    .miText span{ display:block; margin-top:4px; opacity:.70; }
    .miArrow{ font-size:26px; opacity:.65; }

    /* contratos mais “fintech” e com espaçamento */
    .contractCard{
      margin-top:12px;
      padding:16px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }
    .ccTop{
      display:flex; align-items:baseline; justify-content:space-between;
      margin-bottom:14px;
    }
    .ccStatus{ font-weight:800; font-size:22px; }
    .ccId{ opacity:.65; font-weight:600; }

    .ccGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px 18px;
    }
    .ccRow{ display:flex; flex-direction:column; gap:6px; }
    .ccFull{ grid-column: 1 / -1; }

    .ccLabel{ opacity:.70; font-size:14px; letter-spacing:.2px; }
    .ccValue{ font-size:18px; }

    .err{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      opacity:.95;
    }
    .muted{ opacity:.70; }
  </style>
</body>
</html>
