<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal do Cliente</title>

  <link rel="stylesheet" href="./app.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="topbar">
        <div class="brand">
          <img id="logoImg" src="" alt="Logo" />
          <div class="title">
            <strong id="companyName">Portal do Cliente</strong>
            <span id="sessionLine">Carregando sessão...</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnSupport" type="button">Suporte</button>
          <button class="btn danger" id="btnLogout" type="button">Sair</button>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <div class="panel">
            <div class="badge"><span class="dot"></span> Seus contratos</div>
            <div class="hr"></div>
            <div id="contractsBox" class="list">
              <div class="muted">Carregando seus contratos...</div>
            </div>
            <p class="err" id="errBox" style="display:none;"></p>
          </div>

          <div class="panel subtle">
            <h2 class="h2">Resumo</h2>
            <p class="muted">Visão rápida em estilo fintech.</p>

            <div class="mini">
              <div class="miniRow">
                <span>Status</span>
                <strong id="sumStatus">—</strong>
              </div>
              <div class="miniRow">
                <span>Próximo vencimento</span>
                <strong id="sumDue">—</strong>
              </div>
              <div class="miniRow">
                <span>Parcelas restantes</span>
                <strong id="sumInst">—</strong>
              </div>
            </div>

            <div class="hr"></div>
            <p class="muted small">Dica: você pode exibir “Em dia / Atrasado / Quitado” com base no vencimento.</p>
          </div>
        </div>
      </div>
    </div>

    <p class="footer">© <span id="footerCompany">Sua empresa</span></p>
  </div>

  <script>
    // ===== Config + Client =====
    const cfg = window.APP_CONFIG || {};
    const supabaseUrl = cfg.SUPABASE_URL;
    const supabaseKey = cfg.SUPABASE_ANON_KEY;

    function applyBrand() {
      document.getElementById("companyName").textContent = cfg.COMPANY_NAME || "Portal do Cliente";
      document.getElementById("footerCompany").textContent = cfg.COMPANY_NAME || "Portal do Cliente";
      const logo = document.getElementById("logoImg");
      logo.src = cfg.LOGO_URL || "";
      logo.style.display = (logo.src && logo.src !== location.href) ? "block" : "none";
    }

    function showErr(msg) {
      const el = document.getElementById("errBox");
      el.style.display = "block";
      el.textContent = msg;
    }

    function openWhatsApp() {
      const phone = (cfg.SUPPORT_WHATSAPP || "").replace(/\D/g, "");
      const msg = encodeURIComponent(cfg.SUPPORT_MESSAGE || "Olá! Preciso de ajuda com o Portal do Cliente.");
      if (!phone) return showErr("Configure SUPPORT_WHATSAPP no config.js");
      const url = `https://wa.me/${phone}?text=${msg}`;
      window.open(url, "_blank");
    }

    applyBrand();

    if (!supabaseUrl || !supabaseKey) {
      showErr("Config não carregou. Verifique ./config.js (APP_CONFIG).");
    }

    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // ===== Helpers =====
    function fmtBRL(n) {
      const v = Number(n || 0);
      return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }
    function fmtDate(iso) {
      if (!iso) return "—";
      // iso pode vir 'YYYY-MM-DD'
      return iso;
    }
    function statusFromDue(due) {
      if (!due) return "—";
      const today = new Date();
      const d = new Date(due + "T00:00:00");
      const diff = d.getTime() - new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
      if (diff < 0) return "Atrasado";
      if (diff === 0) return "Vence hoje";
      return "Em dia";
    }

    async function requireSession() {
      const { data, error } = await supabase.auth.getSession();
      if (error) throw error;

      const session = data?.session;
      if (!session) {
        window.location.href = "./login.html";
        return null;
      }
      return session;
    }

    async function loadContracts(userId) {
      // Busca contratos do cliente logado (assumindo que contracts.client_id = auth.user.id)
      const { data, error } = await supabase
        .from("contracts")
        .select("id, amount_paid, installments_remaining, due_date, notes")
        .eq("client_id", userId)
        .order("due_date", { ascending: true });

      if (error) throw error;
      return data || [];
    }

    function renderContracts(list) {
      const box = document.getElementById("contractsBox");
      box.innerHTML = "";

      if (!list.length) {
        box.innerHTML = `<div class="muted">Nenhum contrato encontrado para este usuário.</div>`;
        document.getElementById("sumStatus").textContent = "—";
        document.getElementById("sumDue").textContent = "—";
        document.getElementById("sumInst").textContent = "—";
        return;
      }

      // Resumo baseado no primeiro (mais próximo)
      const first = list[0];
      document.getElementById("sumStatus").textContent = statusFromDue(first.due_date);
      document.getElementById("sumDue").textContent = fmtDate(first.due_date);
      document.getElementById("sumInst").textContent = (first.installments_remaining ?? "—");

      for (const c of list) {
        const status = statusFromDue(c.due_date);
        const html = `
          <div class="contract">
            <div class="contractHead">
              <div class="chip">${status}</div>
              <div class="muted small">ID: ${c.id}</div>
            </div>

            <div class="kv">
              <div><span>Valor pago</span><strong>${fmtBRL(c.amount_paid)}</strong></div>
              <div><span>Parcelas restantes</span><strong>${c.installments_remaining ?? "—"}</strong></div>
              <div><span>Vencimento</span><strong>${fmtDate(c.due_date)}</strong></div>
            </div>

            <div class="notes">
              <span>Observações</span>
              <div class="noteBox">${(c.notes || "—").toString()}</div>
            </div>
          </div>
        `;
        box.insertAdjacentHTML("beforeend", html);
      }
    }

    async function doLogout() {
      document.getElementById("btnLogout").disabled = true;
      document.getElementById("btnLogout").textContent = "Saindo...";

      try {
        const { error } = await supabase.auth.signOut();
        if (error) throw error;

        window.location.href = "./login.html";
      } catch (err) {
        showErr(err?.message || "Erro ao sair.");
      } finally {
        document.getElementById("btnLogout").disabled = false;
        document.getElementById("btnLogout").textContent = "Sair";
      }
    }

    document.getElementById("btnSupport").addEventListener("click", openWhatsApp);
    document.getElementById("btnLogout").addEventListener("click", doLogout);

    // ===== Boot =====
    (async () => {
      try {
        const session = await requireSession();
        if (!session) return;

        const email = session.user?.email || "—";
        document.getElementById("sessionLine").textContent = `Logado como: ${email}`;

        const contracts = await loadContracts(session.user.id);
        renderContracts(contracts);
      } catch (err) {
        showErr(err?.message || "Erro ao carregar portal.");
      }
    })();
  </script>
</body>
</html>
